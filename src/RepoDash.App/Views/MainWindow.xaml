<Window x:Class="RepoDash.App.Views.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:converters="clr-namespace:RepoDash.App.Converters"
        Title="RepoDash" Width="1200" Height="800">
  <Window.Resources>
    <converters:ItemCountToHeightConverter x:Key="ItemCountToHeight" ItemHeight="32" />
    <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
  </Window.Resources>
  <DockPanel>
    <!-- Top row -->
    <Grid DockPanel.Dock="Top" Margin="10">
      <Grid.ColumnDefinitions>
        <ColumnDefinition Width="*" />    <!-- 0 Search -->
        <ColumnDefinition Width="Auto" /> <!-- 1 List Height -->
        <ColumnDefinition Width="Auto" /> <!-- 2 Panel Width -->
        <ColumnDefinition Width="Auto" /> <!-- 3 Group Segment -->
        <ColumnDefinition Width="*" />    <!-- 4 Repo Root -->
        <ColumnDefinition Width="Auto" /> <!-- 5 Settings -->
      </Grid.ColumnDefinitions>

      <!-- Search + clear -->
      <Grid Grid.Column="0" Margin="0,0,8,0">
        <Grid.ColumnDefinitions>
          <ColumnDefinition />
          <ColumnDefinition Width="Auto" />
        </Grid.ColumnDefinitions>
        <TextBox Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
                 ToolTip="Type to filter by path. Esc clears."
                 VerticalAlignment="Center" Height="36" Padding="8" />
        <Button Grid.Column="1" Command="{Binding ClearSearchCommand}" Style="{StaticResource IconFlatButton}"
                ToolTip="Clear search">
          <TextBlock Text="✕" FontSize="16" />
        </Button>
      </Grid>

      <!-- List height -->
      <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center" Margin="0,0,8,0">
        <TextBlock Text="List Height:" Margin="0,0,6,0" VerticalAlignment="Center" />
        <TextBox Text="{Binding Settings.ListItemVisibleCount}" Width="60" Height="36" />
      </StackPanel>

      <!-- Panel width -->
      <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center" Margin="0,0,8,0">
        <TextBlock Text="Panel Width:" Margin="0,0,6,0" VerticalAlignment="Center" />
        <TextBox Text="{Binding Settings.GroupPanelWidth}" Width="80" Height="36" />
      </StackPanel>

      <!-- Group segment -->
      <StackPanel Grid.Column="3" Orientation="Horizontal" VerticalAlignment="Center" Margin="0,0,8,0">
        <TextBlock Text="Group Segment:" Margin="0,0,6,0" VerticalAlignment="Center"/>
        <TextBox Text="{Binding Settings.GroupingSegment}" Width="60" Height="36"
                 ToolTip="Which relative path segment (from the end) defines the group"/>
      </StackPanel>


      <!-- Repo root + browse + refresh -->
      <Grid Grid.Column="4" Margin="0,0,8,0">
        <Grid.ColumnDefinitions>
          <ColumnDefinition />
          <!-- TextBox -->
          <ColumnDefinition Width="Auto" />
          <!-- Browse -->
          <ColumnDefinition Width="Auto" />
          <!-- Refresh -->
        </Grid.ColumnDefinitions>

        <TextBox Text="{Binding RepoRootInput, UpdateSourceTrigger=PropertyChanged}"
                 VerticalAlignment="Center" Height="36" Padding="8"
                 ToolTip="Change path and press Enter, click Browse, or Refresh">
          <TextBox.InputBindings>
            <!-- Press Enter inside the textbox to trigger LoadRootCommand -->
            <KeyBinding Key="Enter" Command="{Binding LoadRootCommand}" />
          </TextBox.InputBindings>
        </TextBox>

        <!-- Browse button -->
        <Button Grid.Column="1"
                Command="{Binding BrowseRepoRootCommand}"
                Style="{StaticResource IconFlatButton}"
                ToolTip="Browse for repo root">
          <TextBlock Text="📁" FontSize="14" />
        </Button>

        <!-- Refresh button -->
        <Button Grid.Column="2"
                Command="{Binding LoadRootCommand}"
                Style="{StaticResource IconFlatButton}"
                ToolTip="Refresh (reload current root)">
          <TextBlock Text="↻" FontSize="14" />
        </Button>
      </Grid>


      <!-- Settings menu (placeholder) -->
      <Menu Grid.Column="5" VerticalAlignment="Center">
        <MenuItem Header="Git">
          <MenuItem Header="Fetch all" Command="{Binding GitFetchAllAsyncCommand}"/>
          <MenuItem Header="Pull all (merge)" Command="{Binding GitPullAllAsyncCommand}"/>
          <MenuItem Header="Pull all (rebase)" Command="{Binding GitPullRebaseAllAsyncCommand}"/>
        </MenuItem>
        <MenuItem Header="Settings">
          <MenuItem Header="General"/>
          <MenuItem Header="Repositories"/>
          <MenuItem Header="Shortcuts"/>
          <MenuItem Header="Colors"/>
          <MenuItem Header="External Tools"/>
        </MenuItem>
      </Menu>
    </Grid>

    <!-- Main responsive area -->
    <ScrollViewer VerticalScrollBarVisibility="Auto">
      <ItemsControl ItemsSource="{Binding Groups}">
        <ItemsControl.ItemsPanel>
          <ItemsPanelTemplate>
            <WrapPanel IsItemsHost="True" />
          </ItemsPanelTemplate>
        </ItemsControl.ItemsPanel>

        <ItemsControl.ItemContainerStyle>
          <Style TargetType="ContentPresenter">
            <Setter Property="Width"
                    Value="{Binding DataContext.Settings.GroupPanelWidth, RelativeSource={RelativeSource AncestorType=Window}}" />
            <Setter Property="Margin" Value="10" />
          </Style>
        </ItemsControl.ItemContainerStyle>

        <!-- Group card -->
        <ItemsControl.ItemTemplate>
          <DataTemplate>
            <Border Background="{DynamicResource BrushCardBg}" Padding="8" CornerRadius="8" Style="{StaticResource Card}">
              <DockPanel>
                <TextBlock DockPanel.Dock="Top"
                           Text="{Binding GroupKey}"
                           FontWeight="Bold" Margin="0,0,0,8" />

                <ListBox ItemsSource="{Binding Items}"
                         ScrollViewer.VerticalScrollBarVisibility="Auto"
                         Height="{Binding DataContext.Settings.ListItemVisibleCount,
                 RelativeSource={RelativeSource AncestorType=Window},
                 Converter={StaticResource ItemCountToHeight}}">
                  <ListBox.ItemTemplate>
                    <DataTemplate>
                      <Grid Margin="0,4">
                        <Grid.ColumnDefinitions>
                          <ColumnDefinition/>
                          <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <!-- Left: title + tiny branch -->
                        <StackPanel>
                          <TextBlock>
          <Run Text="{Binding Name}" FontWeight="SemiBold"/>
                          </TextBlock>
                          <TextBlock FontSize="10" Margin="0,2,0,0">
                            <TextBlock.Style>
                              <Style TargetType="TextBlock">
                                <Setter Property="Foreground" Value="{StaticResource BrushTextSubtle}"/>
                                <Style.Triggers>
                                  <DataTrigger Binding="{Binding SyncState}" Value="UpToDate">
                                    <Setter Property="Foreground" Value="Green"/>
                                  </DataTrigger>
                                  <DataTrigger Binding="{Binding SyncState}" Value="Ahead">
                                    <Setter Property="Foreground" Value="DodgerBlue"/>
                                  </DataTrigger>
                                  <DataTrigger Binding="{Binding SyncState}" Value="Behind">
                                    <Setter Property="Foreground" Value="DarkOrange"/>
                                  </DataTrigger>
                                </Style.Triggers>
                              </Style>
                            </TextBlock.Style>
                            <TextBlock Text="*" Foreground="Red" FontWeight="Black"
                                       Visibility="{Binding IsDirty, Converter={StaticResource BooleanToVisibilityConverter}}"
                                       FontSize="10" Margin="0" Padding="0"/>
                            <Run Text="{Binding Branch}"/>
                          </TextBlock>
                        </StackPanel>

                        <!-- Right: flat icon buttons -->
                        <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right">
                          <Button Style="{StaticResource IconFlatButton}" Command="{Binding LaunchCommand}" ToolTip="Launch"  Margin="0,0,4,0">
                            <TextBlock Text="▶" />
                          </Button>
                          <Button Style="{StaticResource IconFlatButton}" Command="{Binding BrowseCommand}" ToolTip="Browse" Margin="0,0,4,0">
                            <TextBlock Text="📁" />
                          </Button>
                          <Button Style="{StaticResource IconFlatButton}" Command="{Binding OpenRemoteAsyncCommand}" ToolTip="Open remote" Margin="0,0,4,0">
                            <TextBlock Text="🌐" />
                          </Button>
                          <Button Style="{StaticResource IconFlatButton}" Command="{Binding OpenPipelinesAsyncCommand}" ToolTip="Pipelines" Margin="0,0,4,0">
                            <TextBlock Text="⛓" />
                          </Button>
                          <Button Style="{StaticResource IconFlatButton}" Command="{Binding OpenGitUiCommand}" ToolTip="Git UI" Margin="0,0,4,0">
                            <TextBlock Text="⚙" />
                          </Button>
                          <Button Style="{StaticResource IconFlatButton}" Command="{Binding CopyNameCommand}" ToolTip="Copy name" Margin="0,0,4,0">
                            <TextBlock Text="⎘" />
                          </Button>
                          <Button Style="{StaticResource IconFlatButton}" Command="{Binding CopyPathCommand}" ToolTip="Copy path" Margin="0,0,4,0">
                            <TextBlock Text="📋" />
                          </Button>
                        </StackPanel>

                        <!-- Context menu -->
                        <Grid.ContextMenu>
                          <ContextMenu>
                            <MenuItem Header="Launch" Command="{Binding LaunchCommand}"/>
                            <MenuItem Header="Browse" Command="{Binding BrowseCommand}"/>
                            <Separator/>
                            <MenuItem Header="Open Remote" Command="{Binding OpenRemoteAsyncCommand}"/>
                            <MenuItem Header="Open Pipelines" Command="{Binding OpenPipelinesAsyncCommand}"/>
                            <MenuItem Header="Git UI" Command="{Binding OpenGitUiCommand}"/>
                            <Separator/>
                            <MenuItem Header="Copy Name" Command="{Binding CopyNameCommand}"/>
                            <MenuItem Header="Copy Path" Command="{Binding CopyPathCommand}"/>
                          </ContextMenu>
                        </Grid.ContextMenu>
                      </Grid>
                    </DataTemplate>
                  </ListBox.ItemTemplate>

                </ListBox>
              </DockPanel>
            </Border>
          </DataTemplate>
        </ItemsControl.ItemTemplate>
      </ItemsControl>
    </ScrollViewer>
  </DockPanel>
</Window>